# 1.2 자바 성능 개요

자바는 처음에 **생산성을 높히고** **성능을 다소 희생**하는 걸 목표로 탄생함.

JVM은 개발자가 직접 하부 리소스를 관리하는 대신 Garbage Collector 같은 서브시스템을 사용해 대신 리소스 관리를 해줌.
따라서 JVM은 런타임 동작이 다소 복잡하다는 특징이 있다.

자바 성능의 특징
- JVM 성능 측정값은 정규 분포를 따르지 않아서 기초 통계 기법으로 측정 결과 제대로 처리하기 힘듦
- 측정하는 행위 자체가 오버헤드를 일으켜서 너무 자주 샘플링하면 성능 결과 수치에 영향을 미칠 수 있음

# 1.3 성능은 실험과학이다

JVM 성능 튜닝을 위해서는 여러 조건에서 실험을 통해 원하는 결과를 도출해야 한다.

1. 원하는 결과를 정의
2. 기존 시스템 측정
3. 요건 충족을 위해 해야 하는 일 정하기
4. 개선 활동 추진
5. 다시 테스트
6. 목표 달성 됐는지 판단한다.

**예시**
1. 100RPS의 부하 상황에서 99%의 응답시간에 대해 100ms 이하를 만족하고 싶다.
2. 현재 시스템을 측정하면 50RPS 정도에서 벌써 100ms를 초과한다.
3. APM 툴로 병목 구간 분석해보니 DB 조회에서 시간이 많이 걸린다.
4. **쿼리 최적화**, **인덱스 세팅**, 데이터 특성에 따라 **캐시 도입** 등의 개선 작업 수행
5. 다시 성능 테스트
6. 100RPS에서 100ms 이하를 충분히 달성함으로 개선 성공

# 1.4 성능 분류

### 처리율
- 시스템이 수행 가능한 작업 비율을 나타낸다. 가장 많이 사용되는 지표는 **TPS**(Transaction Per Second)
- TPS를 측정할때는 테스트를 진행한 서버 스펙, 스케일 아웃 상태 등을 명확히 해야한다.
- TPS를 측정하는 테스트는 항상 동일한 작업 단위를 대상으로 수행해야 한다.
### 지연
- 1초에 100리터를 흘려보내는 수도관에서 처리율은 1초에 처리되는 물의 부피(100L)
- 지연시간은 수도관의 길이를 의미한다. 즉, 작업의 종단 시간을 의미함

### 용량
- 시스템이 동시 처리 가능한 작업 단위의 개수
### 사용률
- 시스템 리소스를 효율적으로 활용하도록 만드는게 성능 분석에서 중요한 부분
- 사용률은 어떤 작업이냐에 따라 달라질 수 있다.
    - CPU Intensive한 작업은 CPU 사용률 높고 Memory 사용률 낮음
### 효율
- 효율은 처리율을 리소스 사용률로 나눈 값
- 같은 처리율을 더 적은 리소스 사용률로 달성할 수 있다면 효율적임

### 확장성
- 리소스 추가에 따른 처리율 변화는 시스템/어플리케이션의 확장성을 가늠하는 척도
- 리소스 n배 증가에 따라 처리율이 n배 증가하면 완전한 선형 확장이다. 하지만 현실에서는 가능성 적음.
- 지속적으로 스케일 아웃을 하다보면 한계점에 도달하게 됨.

### 저하
- 트래픽의 증가로 시스템이 부하를 받으면 성능 저하가 발생할 수 있음.
- 현재 리소스 사용률에 따라 다르다. 리소스 덜 사용하고 있으면 저하는 덜 발생하고, 시스템 풀 가동 상태면 처리율은 증가하지 않고 성능 저하 급격히 발생.

### 측정값 사이의 연관 관계

각각의 측정값은 서로 영향을 줄 수 있다.

**JIT Compiler 예시**

JIT Compiler가 네이티브 코드로 컴파일해서 코드 캐시에 저장하는 기준은 메서드가 호출되서 인터프리팅 된 횟수이다.
따라서 부하가 적어서 메서드가 별로 호출 안되면 기준을 불충족해서 계속 인터프리팅을 하게 되고, 일정 부하를 넘어서야 컴파일 된다.


# 1.5 성능 그래프 읽기

<img width="500" alt="스크린샷 2024-01-10 오후 6 24 43" src="https://github.com/CMC11th-Melly/Melly_Server/assets/82302520/a591d14f-0001-4ce0-a496-df42706f0575">

부하가 증가하면서 예기치 않게 지연이 발생하는 그래프를 **성능 엘보**라고 한다.

**실제 발생 가능할 만한 상황**
- 커넥션풀/쓰레드풀이 고갈되서 더이상 요청을 처리하지 못할때

무상태 환경에서 스케일 아웃을 하면 준-선형적 그래프를 그릴 수 있음

### 암달의 법칙

프로세스 내에는 순차 처리가 필요한 부분이 반드시 있기에 아무리 병렬 처리를 해도 더이상 성능 향상이 되지 않는 **한계점이 존재**한다는 법칙

90% 병렬화 그래프는 **10% 순차 처리**를 의미한다. 10%만 순차처리를 해도 프로세서 개수를 1024개로 늘린 상황에서 **10배 이상은 시간 단축이 되지 않는다**. 즉 한계에 부딫힘