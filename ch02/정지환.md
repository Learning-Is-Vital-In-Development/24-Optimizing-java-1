# CH2

### 2.1 인터프리팅과 클래스로딩

- JVM은 스택 기반의 해석 머신이다.
- 레지스터는 없지만 실행 스택에 보관하며, 이 스택의 맨 위에 쌓인 값을 가져와 계산한다.

인터프리터

- 기본 로직은 while안에 switch문

클래스로딩

- 제어권을 클래스로 넘기러면 가상 머신이 실행이 되기 전에 클래스를 로드해야한다.
- 부트스트랩 클래스가 자바 런타임 코어 클래스를 로드한다.
- 자바9 이후부터는 런타임이 모듈화되고 클래스로딩 개념이 많이 달라졌다.

부트스트랩 클래스로더

- 다른 클래스로더가 나머지 시스템에 필요한 클래스를 로드할 수 있게 최소한의 필수 클래스(java.lang.Object, Class, Classloader)만 로드한다.

확장 클래스로더

- 부트스트랩 클래스로더를 부모로 설정하고 필요할때 클래스로딩 작업을 부모에게 넘긴다.

애플리케이션 클래스로더

- 지정된 클래스패스에 위차한 유저클래스를 로드한다.
- 확장 클래스로더의 자식

클래스로딩 순서

- 처음 보는 새 클래스를 디펜던시에 로드
- 클래스를 찾지 못한 클래스로더는 기본적으로 부모에게 대신 룩업을 넘긴다.
- 부트스트랩도 룩업하지 없다면 ClassNotFoundException 예외 발생

> 한 시스템에서 클래스는 풀 클래스명과 자신을 로드한 클래스로더, 두가지 정보로 식별된다.
>

### 2.2 바이트코드 실행

- 자바 소스코드의 가장 첫단계는 javac를 이용해 컴파일 과정이다. 즉 바이트코드로 가득찬 .class파일로 바꾸는 것.
- 바이트코드는 특정 컴퓨터 아키텍처에 특정하지 않는다.

클래스 파일 구**조**

- 매직넘버
- 클래스 파일 포매 버전
- 상수 풀
- 엑세스 플래그
- this 클래스
- 슈퍼클래스
- 인터페이스
- 필드
- 메서드
- 속성

### 2.3 핫스팟 입문

제로-오버헤드 원칙

- 컴퓨터와 OS가 어떻게 작동해야하는지 개발자가 알려주어야한다.
- 핫스팟은 성능에 유리한 방향으로 최적화를 적용하는 가상머신이다.

JIT 컴파일

- 프로그램 단위(메서드와 루프)를 인터프리티드 바이트코드에서 네이티브 코드로 컴파일
- 인터프리티드 모드로 실행하는 동안 애플리케이션을 모니터링하며 가장 자주 실행되는 코드 파트를 JIT 컴파일 수행
- 컴파일러가 해석 단계에서 수집한 추적 정보를 토대로 최적화를 결정하는 것이 가장 큰 장점

### 2.4 JVM 메모리 관리

- 자바는 가비지 수집이라는 플세스를 이용해 힙 메모리를 자동 관리한다.
- GC가 실행되면 그동안 다른 애플리케이션은 모두 중단되고 하던 일을 멈춰야한다.

### 2.5 스레딩과 자바 메모리 모델

- JVM 구현체에서 자바 애플리케이션 스레드는 가각 정확히 하나의 전용 OS 스레드에 대응된다.
- 자바 멀티스레드 방식은 세가지에 기반한다
    - 모든 스레드는 가비지가 수집되는 하나의 공용 힙을 가진다.
    - 한 스레드가 생성한 객체는 그 객체를 참조하는 다른 스레드가 액세스할 수 있다.
    - 객체는 변경 가능하다.(final 제외)
- OS 스케줄러가 언제라도 CPU코어에서 강제로 스레드를 방출할 수 있기 때문에 복잡한 문제다.

### 2.6 JVM 구현체 종류

- 오라클이 제작한 핫스팟 의외에도 다른 방법으로 구현한 자바 구현체가 많다.
- OpenJDK
    - 자바 기준 구현체를 제공하는 특별한 오픈소스 프로젝트
    - 자바 릴리즈 기준 발표
- Oracle Java
    - OpenJDK 기반이지만 상용 라이선스이다.

### 2.7 JVM 모니터링과 툴링

- JVM에서는 실행중인 어플리케이션은 인스트루먼테이션(진단, 성능 개선), 모니터링 하는 다양한 기술을 제공한다.

JMX

- JVM과 그 위에서 동작하는 어플리케이션을 제어하고 모니터링하는 범용 툴
- 클라이언트 어플리케이션처럼 메서드를 호출하고 매개변수를 바꿀 수 있다.

자바 에이전트

- 자바 언어로 작성된 툴 컴포넌트
- java.lang.instrument 인터페이솔 메서드 바이트코드를 조작한다.

JMVTI

- JVM의 네이티브 인터페이스, JVMTI를 상용하는 에이전트는 네이티브 컴파일 언어로 작성해야한다.
- 실행 중인 어플리케이션에 악영향을 미칠 수 있어 가급적 자바 에이전트로 작성하는 게 낫다.

SA

- 자바 객체, 핫스팟 자료 구조 모두 표출 가능한 API와 툴을 모아놓은 것
